<!-- prettier-ignore -->
{% extends 'dashboard_base.html' %}
<!-- prettier-ignore -->
{% block title %}Vehicle Master{% endblock title %}
<!-- prettier-ignore -->
{% block dashboard_content %}

<div class="py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-full mx-auto">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
      <div class="flex flex-col sm:flex-row items-center gap-4 w-full">
        <div class="relative flex-grow">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input type="text" id="searchInput" placeholder="Search by chassis, plate, make..." class="w-full pl-12 pr-4 py-2.5 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200 text-slate-900 placeholder-slate-400 bg-white shadow-sm hover:border-slate-400">
        </div>
        <div class="flex items-center gap-3">
          <a href="{% url 'download_csv' %}" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 hover:border-slate-400 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all duration-200">
            <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Download CSV
          </a>
          <a href="{% url 'vehicle_create' %}" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-teal-600 to-cyan-600 border border-transparent rounded-lg shadow-md hover:from-teal-700 hover:to-cyan-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all duration-200">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Vehicle
          </a>
        </div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMsg" class="text-sm mb-6 font-medium empty:hidden"></div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <!-- Card 1: Total Vehicles -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <p class="text-xs font-semibold text-slate-500 uppercase">Total Vehicles</p>
        <p id="totalCount" class="text-2xl font-bold text-slate-800">-</p>
      </div>
      <!-- Card 2: Active -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <p class="text-xs font-semibold text-slate-500 uppercase">Active</p>
        <p id="activeCount" class="text-2xl font-bold text-green-600">-</p>
      </div>
      <!-- Card 3: With GPS -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <p class="text-xs font-semibold text-slate-500 uppercase">With GPS</p>
        <p id="gpsCount" class="text-2xl font-bold text-blue-600">-</p>
      </div>
      <!-- Card 4: With Lift Gate -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
        <p class="text-xs font-semibold text-slate-500 uppercase">With Lift Gate</p>
        <p id="liftGateCount" class="text-2xl font-bold text-orange-600">-</p>
      </div>
    </div>


    <!-- Table Container -->
    <div class="bg-white border-2 border-slate-200 rounded-xl shadow-xl overflow-hidden">
      <!-- Table Info Bar -->
      <div class="bg-gradient-to-r from-slate-50 to-white px-6 py-3 border-b-2 border-slate-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-2 h-2 bg-teal-500 rounded-full animate-pulse"></div>
          <h3 class="text-sm font-semibold text-slate-700">Fleet Inventory</h3>
        </div>
        <div class="text-xs text-slate-500 font-medium" id="tableInfo">Loading...</div>
      </div>
      <!-- Scrollable wrapper with max height and custom scrollbar -->
      <div class="overflow-x-auto overflow-y-auto max-h-[650px] relative table-container" style="scrollbar-width: thin; scrollbar-color: #64748b #e2e8f0;">
        <style>
          .table-container::-webkit-scrollbar {
            height: 12px;
            width: 12px;
          }
          .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
          }
          .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #64748b, #475569);
            border-radius: 6px;
            border: 2px solid #f1f5f9;
          }
          .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #475569, #334155);
          }
          .table-container::-webkit-scrollbar-corner {
            background: #f1f5f9;
          }
        </style>
        <table class="w-full table-auto text-sm text-left text-slate-600 whitespace-nowrap">
          <thead class="bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 text-xs uppercase text-white font-bold tracking-wider sticky top-0 z-10">
            <tr>
              <th class="px-5 py-4 sticky left-0 bg-slate-800 z-20 border-r-2 border-slate-600 shadow-[4px_0_8px_-2px_rgba(0,0,0,0.4)]">
                Plate #
              </th>
              <th class="px-5 py-4">Chassis #</th>
              <th class="px-5 py-4">Vehicle Capacity</th>
              <th class="px-5 py-4">Vehicle Type</th>
              <th class="px-5 py-4">Tote Capacity</th>
              <th class="px-5 py-4">Status</th>
              <th class="px-5 py-4">Vehicle Concept</th>
              <th class="px-5 py-4">Make</th>
              <th class="px-5 py-4">Truck Reg Date</th>
              <th class="px-5 py-4">Truck Reg Expiry Date</th>
              <th class="px-5 py-4">Insurance Doc</th>
              <th class="px-5 py-4">Insurance Start Date</th>
              <th class="px-5 py-4">Insurance Expiry Date</th>
              <th class="px-5 py-4">Mulkia Reg Date</th>
              <th class="px-5 py-4">Mulkia Reg Expiry Date</th>
              <th class="px-5 py-4">Mulkia Doc</th>
              <th class="px-5 py-4">Emirates Permit</th>
              <th class="px-5 py-4">Permit Reg Date</th>
              <th class="px-5 py-4">Permit Reg Expiry Date</th>
              <th class="px-5 py-4">Permit Doc</th>
              <th class="px-5 py-4">TL No</th>
              <th class="px-5 py-4">TC No</th>
              <th class="px-5 py-4">TC Owner</th>
              <th class="px-5 py-4">Salik Acc No</th>
              <th class="px-5 py-4">Salik Tag No</th>
              <th class="px-5 py-4">Darb Acc No</th>
              <th class="px-5 py-4">GPS</th>
              <th class="px-5 py-4">Branding Status</th>
              <th class="px-5 py-4">Lift Gate</th>
              <th class="px-5 py-4">Tail Lift Brand</th>
              <th class="px-5 py-4 max-w-xs">Remarks</th>
              <th class="px-5 py-4">Truck Photos</th>
            </tr>
          </thead>
          <tbody id="vehicleTbody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="28" class="px-4 py-12 text-center">
                <div class="flex flex-col items-center justify-center">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mb-4"></div>
                  <p class="text-slate-600 font-medium">Loading vehicles...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const apiListUrl = "{% url 'vehicle_master_api' %}";
  const statusMsg = document.getElementById("statusMsg");
  const tbody = document.getElementById("vehicleTbody");
  const editPageBaseUrl = "/office/vehicle-update/";
  const searchInput = document.getElementById("searchInput");

  let allVehicles = [];

  const createBadge = (text, colorClass = "bg-slate-100 text-slate-700") => {
    if (!text) return '<span class="text-slate-400">-</span>';
    return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${colorClass}">${text}</span>`;
  };

  const createDocLink = (url) => {
    if (!url) return '<span class="text-slate-300">-</span>';
    return `<a href="${url}" target="_blank" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-teal-700 bg-teal-50 rounded-lg hover:bg-teal-100 transition-all duration-200 shadow-sm hover:shadow">
              <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              View
            </a>`;
  };

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("updated") === "1") {
    statusMsg.innerHTML = `<div class="flex items-center p-4 text-green-700 bg-green-50 border border-green-200 rounded-lg shadow-sm">
      <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span class="font-medium">Vehicle updated successfully!</span>
    </div>`;
  }

  async function fetchVehicles() {
    try {
      const res = await fetch(apiListUrl, { credentials: "same-origin" });
      if (!res.ok) {
        statusMsg.innerHTML = `<div class="flex items-center p-4 text-red-700 bg-red-50 border border-red-200 rounded-lg shadow-sm">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="font-medium">Failed to load vehicles. Please try again.</span>
        </div>`;
        return;
      }
      const data = await res.json();
      allVehicles = data;
      updateStatistics(data);
      renderRows(data);
    } catch (err) {
      statusMsg.innerHTML = `<div class="flex items-center p-4 text-red-700 bg-red-50 border border-red-200 rounded-lg shadow-sm">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="font-medium">Network error. Please check your connection.</span>
      </div>`;
    }
  }

  function updateStatistics(data) {
    const totalCount = data.length;
    const activeCount = data.filter(v => v.status?.name?.toLowerCase().includes('active')).length;
    const gpsCount = data.filter(v => v.gps?.name).length;
    const liftGateCount = data.filter(v => v.lift_gate).length;

    document.getElementById("totalCount").textContent = totalCount;
    document.getElementById("activeCount").textContent = activeCount;
    document.getElementById("gpsCount").textContent = gpsCount;
    document.getElementById("liftGateCount").textContent = liftGateCount;
    document.getElementById("tableInfo").textContent = `Showing ${totalCount} vehicle${totalCount !== 1 ? 's' : ''}`;
  }

  function renderRows(data) {
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="28" class="px-4 py-12 text-center">
        <div class="flex flex-col items-center justify-center">
          <svg class="w-16 h-16 text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
          </svg>
          <p class="text-slate-600 font-medium mb-2">No vehicles found</p>
          <p class="text-sm text-slate-500">Try adjusting your search criteria</p>
        </div>
      </td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    for (const v of data) {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50 transition duration-150 ease-in-out group";

      const editUrl = editPageBaseUrl + encodeURIComponent(v.chassis_number) + "/";

      const cells = [
        {
          value: `<a href="${editUrl}" class="font-bold text-teal-700 hover:text-teal-900 hover:underline transition-colors inline-flex items-center gap-2">
            <svg class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            ${v.plate_number}
          </a>`,
          className: "sticky left-0 bg-white group-hover:bg-slate-50 border-r-2 border-slate-200 z-10 shadow-[4px_0_8px_-2px_rgba(0,0,0,0.1)]",
        },
        {
          value: `<a href="${editUrl}" class="text-slate-900 font-medium hover:text-teal-700 hover:underline transition-colors">${v.chassis_number}</a>`
        },
        { value: createBadge(v.vehicle_capacity?.name, "bg-purple-100 text-purple-700") },
        { value: createBadge(v.vehicle_type?.name, "bg-blue-100 text-blue-700") },
        { value: v.tote_capacity?.name ?? '<span class="text-slate-400">-</span>' },
        { value: createBadge(v.status?.name, "bg-slate-100 text-slate-800") },
        { value: v.vehicle_concept?.name ?? '<span class="text-slate-400">-</span>' },
        { value: `<span class="font-medium text-slate-700">${v.make?.name ?? ""}</span>` },
        { value: v.truck_reg_date ?? '<span class="text-slate-400">-</span>' },
        { value: v.truck_registration_expiry_date ?? '<span class="text-slate-400">-</span>' },
        { value: createDocLink(v.insurance_document_url) },
        { value: v.insurance_registration_date ?? '<span class="text-slate-400">-</span>' },
        { value: v.insurance_registration_expiry_date ?? '<span class="text-slate-400">-</span>' },
        { value: v.mulkia_registration_date ?? '<span class="text-slate-400">-</span>' },
        { value: v.mulkia_registration_expiry_date ?? '<span class="text-slate-400">-</span>' },
        { value: createDocLink(v.mulkia_document_url) },
        { value: v.emirates_permit.map((e) => e.name).join(", ") || '<span class="text-slate-400">-</span>' },
        { value: v.permit_registration_date ?? '<span class="text-slate-400">-</span>' },
        { value: v.permit_registration_expiry_date ?? '<span class="text-slate-400">-</span>' },
        { value: createDocLink(v.permit_document_url) },
        { value: v.tl_no ?? '<span class="text-slate-400">-</span>' },
        { value: v.tc_no ?? '<span class="text-slate-400">-</span>' },
        { value: v.tc_owner ?? '<span class="text-slate-400">-</span>' },
        { value: v.salik_account_no ?? '<span class="text-slate-400">-</span>' },
        { value: v.salik_tag_no ?? '<span class="text-slate-400">-</span>' },
        { value: v.darb_ac_no ?? '<span class="text-slate-400">-</span>' },
        { value: v.gps?.name ?? '<span class="text-slate-400">-</span>' },
        { value: createBadge(v.branding_status?.name, "bg-amber-100 text-amber-700") },
        { value: v.lift_gate ? createBadge("Yes", "bg-green-100 text-green-700") : '<span class="text-slate-400">No</span>' },
        { value: v.tail_lift_brand?.name ?? '<span class="text-slate-400">-</span>' },
        { value: `<span class="block truncate max-w-xs text-slate-600" title="${v.remarks || ""}">${v.remarks || '<span class="text-slate-400">-</span>'}</span>` },
        { value: createDocLink(v.truck_photos_url) },
      ];

      for (let cell of cells) {
        const td = document.createElement("td");
        td.className = `px-5 py-4 whitespace-nowrap text-sm ${cell.className || ""}`;
        td.innerHTML = cell.value;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }
  }

  searchInput.addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = allVehicles.filter(v => {
      return (
        v.chassis_number?.toLowerCase().includes(searchTerm) ||
        v.plate_number?.toLowerCase().includes(searchTerm) ||
        v.make?.name?.toLowerCase().includes(searchTerm)
      );
    });
    renderRows(filtered);

    const resultCountEl = document.getElementById("resultCount");
    const resultCountText = document.getElementById("resultCountText");
    if (searchTerm) {
      resultCountEl.classList.remove("hidden");
      resultCountEl.classList.add("flex");
      resultCountText.textContent = `${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
      document.getElementById("tableInfo").textContent = `Showing ${filtered.length} of ${allVehicles.length} vehicle${filtered.length !== 1 ? 's' : ''}`;
    } else {
      resultCountEl.classList.add("hidden");
      resultCountEl.classList.remove("flex");
      document.getElementById("tableInfo").textContent = `Showing ${allVehicles.length} vehicle${allVehicles.length !== 1 ? 's' : ''}`;
    }
  });

  fetchVehicles();
</script>

{% endblock dashboard_content %}
